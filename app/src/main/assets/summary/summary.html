<!--
  ~ Copyright (C) 2026 ankio(ankio@ankio.net)
  ~ Licensed under the Apache License, Version 3.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~         http://www.apache.org/licenses/LICENSE-3.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~   limitations under the License.
  ~
  ~ ========================================
  ~ æ¶ˆè´¹åˆ†ææŠ¥å‘Šé¡µé¢
  ~ ========================================
  ~
  ~ åŠŸèƒ½è¯´æ˜ï¼š
  ~ 1. å±•ç¤ºç”¨æˆ·çš„æ¶ˆè´¹åˆ†ææ•°æ®ï¼ŒåŒ…æ‹¬æ”¶æ”¯è¶‹åŠ¿ã€åˆ†ç±»ç»Ÿè®¡ã€å•†æˆ·åˆ†æç­‰
  ~ 2. æ”¯æŒé€šè¿‡ window.setJson(data) å¤–éƒ¨æ³¨å…¥æ•°æ®
  ~ 3. æ•°æ®æ ¼å¼ä¸ SummaryService.generateSummary() è¿”å›çš„ JSON ä¸€è‡´
  ~
  ~ å¯è§†åŒ–æ¨¡å—ï¼š
  ~ - æ€»è§ˆç»Ÿè®¡ï¼ˆæ”¶å…¥ã€æ”¯å‡ºã€ç»“ä½™ã€äº¤æ˜“æ€»æ•°ï¼‰
  ~ - æ”¶æ”¯è¶‹åŠ¿å›¾ï¼ˆæ™ºèƒ½æ—¶é—´ç²’åº¦ï¼šå¹´/æœˆ/æ—¥ï¼‰
  ~ - åˆ†ç±»åˆ†æï¼ˆæ”¯å‡º/æ”¶å…¥åˆ†ç±»é¥¼å›¾ï¼‰
  ~ - æ—¥å‡åˆ†æï¼ˆæ—¥å‡æ”¯å‡ºã€æ”¶å…¥ã€é¢‘ç‡ï¼‰
  ~ - æ¶ˆè´¹æ—¶é—´è§„å¾‹ï¼ˆ24å°æ—¶æŸ±çŠ¶å›¾ï¼‰
  ~ - æ¶ˆè´¹ç”Ÿç‰©é’Ÿï¼ˆå‘¨Ã—å°æ—¶çƒ­åŠ›å›¾ï¼‰
  ~ - é‡‘é¢åˆ†å¸ƒï¼ˆæŒ‰åŒºé—´ç»Ÿè®¡ï¼‰
  ~ - æ¶ˆè´¹è±¡é™ï¼ˆé¢‘æ¬¡vså‡ä»·æ•£ç‚¹å›¾ï¼‰
  ~ - æ¶ˆè´¹æ´å¯Ÿï¼ˆç”»åƒã€æ‹¿é“å› å­ã€å¤§é¢æ”¯å‡ºã€å‘¨æœ«æ•ˆåº”ï¼‰
  ~ - æ¶ˆè´¹çƒ­è¯äº‘ï¼ˆå•†æˆ·å’Œåˆ†ç±»è¯äº‘ï¼‰
  ~ - æœ€å¸¸å…‰é¡¾å•†æˆ·TOP20
  ~
  ~ å¤–éƒ¨è°ƒç”¨ç¤ºä¾‹ï¼š
  ~ window.setJson({
  ~     period: "2024å¹´1æœˆ",
  ~     periodDays: 31,
  ~     basicStats: { totalIncome: 10000, totalExpense: 5000, ... },
  ~     expenseByCategory: [...],
  ~     bills: [...]
  ~ });
  -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆè´¹åˆ†ææŠ¥å‘Š</title>
    <script src="./echarts.min.js"></script>
    <script src="./echarts-wordcloud.min.js"></script>
    <style>
        /* CSSå˜é‡å®šä¹‰ï¼ˆMaterial 3 ä¸»é¢˜è‰²ï¼Œé¢œè‰²ç”±å¤–éƒ¨æ³¨å…¥ï¼‰ */
        :root {
            /* åŸºç¡€è‰²é˜¶ */
            --color-bg: #fffbfe;
            --color-card: #fffbfe;
            --color-card-hover: #f5eff7;
            --color-text: #1c1b1f;
            --color-text-light: #49454f;
            --color-text-muted: #79747e;
            /* ä¸»é¢˜è‰²ï¼ˆMaterial 3ï¼‰ */
            --color-primary: #6750a4;
            --color-primary-light: #eaddff;
            --color-secondary: #625b71;
            --color-tertiary: #7d5260;
            --color-on-primary: #ffffff;
            --color-on-secondary: #ffffff;
            --color-success: #006c4b;
            --color-success-bg: #b6f1d8;
            --color-danger: #b3261e;
            --color-danger-bg: #f9dedc;
            --color-warning: #8d6e00;
            --color-warning-bg: #ffddb4;
            --color-border: #79747e;
            --color-surface-variant: #e7e0ec;
            --color-outline: #79747e;
            --color-gradient-start: #8b5cf6;
            --color-gradient-end: #6750a4;
        }

        /* ä»…ä½¿ç”¨é»˜è®¤æµ…è‰²ä¸»é¢˜ï¼Œä¸é€‚é…æ·±è‰²æ¨¡å¼ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* é¡µé¢å…¨å±€åŸºç¡€æ ·å¼ï¼ˆMaterial 3 æ’ç‰ˆä¸èƒŒæ™¯ï¼‰ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¡ç‰‡æ ·å¼ */
        /* å¡ç‰‡å®¹å™¨ï¼ˆMaterial 3 é«˜ç¨‹ï¼‰ */
        .card {
            background: var(--color-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }



        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text);
        }

        .card-title .icon {
            font-size: 24px;
        }

        /* ç»Ÿè®¡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }

        /* ç»Ÿè®¡å—ï¼ˆMaterial 3 surface variantï¼‰ */
        .stat-item {
            background: var(--color-surface-variant);
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s;
        }

        /* ç»Ÿè®¡å—æ‚¬æµ®ï¼ˆä¸»è‰²æè¾¹ï¼‰ */
        .stat-item:hover {
            border-color: var(--color-primary);
            background: var(--color-card);
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-light);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .stat-value.income {
            color: var(--color-income, var(--color-success));
        }

        .stat-value.expense {
            color: var(--color-expense, var(--color-danger));
        }

        .stat-value.primary {
            color: var(--color-primary);
        }

        .stat-compare {
            font-size: 13px;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-compare.up {
            color: var(--color-expense, var(--color-danger));
        }

        .stat-compare.down {
            color: var(--color-income, var(--color-success));
        }


        .stat-compare.up::before {
            border-bottom: 6px solid var(--color-expense, var(--color-danger));
        }

        .stat-compare.down::before {
            border-top: 6px solid var(--color-income, var(--color-success));
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart {
            width: 100%;
            height: 380px;
            margin-top: 16px;
        }

        .chart-medium {
            height: 320px;
        }

        .chart-small {
            height: 280px;
        }

        /* åˆ†ç±»å›¾è¡¨å°ºå¯¸ï¼šå¢åŠ é«˜åº¦ä»¥å±•ç¤ºæ›´å¤šå†…å®¹ */
        .category-chart {
            height: 420px;
        }

        /* Tabåˆ‡æ¢ */
        /* åˆ†æ®µæŒ‰é’®å®¹å™¨ï¼ˆMaterial 3ï¼‰ */
        .tab-group {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 4px;
            background: var(--color-surface-variant);
            border-radius: 10px;
            width: fit-content;
        }

        /* åˆ†æ®µæŒ‰é’®ï¼ˆMaterial 3ï¼‰ */
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--color-text-light);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s;
        }

        /* åˆ†æ®µæŒ‰é’®æ‚¬æµ®æ€ */
        .tab-btn:hover {
            background: var(--color-card);
        }

        /* åˆ†æ®µæŒ‰é’®é€‰ä¸­æ€ */
        .tab-btn.active {
            background: var(--color-primary);
            color: var(--color-on-primary);
        }


        /* æ´å¯Ÿå¡ç‰‡ */
        /* æ´å¯Ÿå¡ç‰‡ï¼ˆMaterial 3 è½»åº¦æ¸å˜ï¼‰ */
        .insight-card {
            background: linear-gradient(135deg, var(--color-primary-light) 0%, var(--color-card-hover) 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--color-primary);
        }

        .insight-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--color-primary);
        }

        .insight-content {
            font-size: 14px;
            line-height: 1.8;
            color: var(--color-text-light);
        }

        /* æ ‡ç­¾ */
        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin: 4px;
        }

        /* æ ‡ç­¾é¢œè‰²ï¼ˆMaterial 3 è‰²é˜¶ï¼‰ */
        .tag-primary {
            background: var(--color-primary-light);
            color: var(--color-primary);
        }

        .tag-success {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .tag-warning {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }

        .tag-danger {
            background: var(--color-danger-bg);
            color: var(--color-danger);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-muted);
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state .text {
            font-size: 16px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .card {
                padding: 16px;
                border-radius: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-value {
                font-size: 22px;
            }

            .chart {
                height: 280px;
            }

            .chart-medium {
                height: 240px;
            }

            .chart-small {
                height: 220px;
            }

            .merchant-rank {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
        }

    </style>
</head>
<body>
<div class="container">
    <!-- æ€»è§ˆéƒ¨åˆ† -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ“Š</span> æ€»è§ˆ</div>
        <div class="stats-grid" id="overviewStats"></div>
    </div>

    <!-- è¶‹åŠ¿å›¾ -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ“ˆ</span> æ”¶æ”¯è¶‹åŠ¿</div>
        <div class="chart" id="trendChart"></div>
    </div>

    <!-- åˆ†ç±»åˆ†æ -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ·ï¸</span> åˆ†ç±»åˆ†æ</div>
        <div class="tab-group">
            <button class="tab-btn active" onclick="switchCategoryTab('expense')">æ”¯å‡ºåˆ†ç±»</button>
            <button class="tab-btn" onclick="switchCategoryTab('income')">æ”¶å…¥åˆ†ç±»</button>
        </div>
        <!-- åˆ†ç±»å›¾è¡¨ï¼šç¼©å°é«˜åº¦å¹¶è®©å›¾ä¾‹å±…åº•æ˜¾ç¤ºï¼Œå‡å°‘æ¨ªå‘æŒ¤å‹ -->
        <div class="chart chart-medium category-chart" id="categoryChart"></div>

        <!-- åˆ†ç±»æ´å¯Ÿ -->
        <div id="categoryInsight" style="margin-top: 16px"></div>
    </div>

    <!-- æ—¥å‡åˆ†æ -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ“…</span> æ—¥å‡åˆ†æ</div>
        <div class="stats-grid" id="dailyStats"></div>
    </div>

    <!-- æ¶ˆè´¹è§„å¾‹ - æ—¶é—´æ®µåˆ†æ -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ•</span> æ¶ˆè´¹æ—¶é—´è§„å¾‹</div>
        <div class="chart chart-medium" id="hourChart"></div>
        <div id="timeInsight" style="margin-top: 16px"></div>
    </div>

    <!-- æ¶ˆè´¹ç”Ÿç‰©é’Ÿï¼ˆçƒ­åŠ›å›¾ï¼‰ -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ”¥</span> æ¶ˆè´¹ç”Ÿç‰©é’Ÿï¼ˆçƒ­åŠ›å›¾ï¼‰</div>
        <div class="chart" id="heatmapChart" style="margin-top: 16px"></div>
    </div>

    <!-- é‡‘é¢åˆ†å¸ƒ -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ’°</span> é‡‘é¢åˆ†å¸ƒ</div>
        <div class="chart chart-small" id="amountDistChart"></div>
    </div>

    <!-- æ¶ˆè´¹è±¡é™ï¼ˆé¢‘æ¬¡ vs å‡ä»·ï¼‰ -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ“</span> æ¶ˆè´¹è±¡é™ï¼ˆé¢‘æ¬¡ vs å‡ä»·ï¼‰</div>
        <div class="chart chart-medium" id="scatterChart"></div>
    </div>

    <!-- æ¶ˆè´¹æ´å¯Ÿ -->
    <div class="card">
        <div class="card-title"><span class="icon">ğŸ”</span> æ¶ˆè´¹æ´å¯Ÿ</div>
        <div id="insightContent"></div>
    </div>

    <!-- æ¶ˆè´¹çƒ­è¯äº‘ -->
    <div class="card">
        <div class="card-title"><span class="icon">â˜ï¸</span> æ¶ˆè´¹çƒ­è¯äº‘</div>
        <div class="chart chart-medium" id="wordCloudChart"></div>
    </div>

    <!-- æœ€å¸¸å…‰é¡¾å·²ç§»é™¤ï¼šè¯äº‘å·²è¦†ç›–å•†æˆ·ä¿¡æ¯ -->
</div>

<script>
    /**
     * é»˜è®¤æ•°æ®ç»“æ„ï¼ˆæœåŠ¡ç«¯è®¡ç®—åé€šè¿‡setJsonæ³¨å…¥ï¼‰
     * ä»…ç”¨äºé¿å…ç©ºæŒ‡é’ˆï¼Œå®é™…å±•ç¤ºä»¥æœåŠ¡ç«¯è¿”å›ä¸ºå‡†
     */
    const defaultData = {
        // å‘¨æœŸä¿¡æ¯
        period: "",
        periodDays: 0,

        // åŸºç¡€ç»Ÿè®¡
        basicStats: {
            totalIncome: 0,
            totalExpense: 0,
            hasIncome: false,
            avgIncomePerDay: 0,
            avgExpensePerDay: 0,
            savingsRate: 0,
            expenseIncomeRatio: 0
        },

        // æ”¯å‡º/æ”¶å…¥åˆ†ç±»ç»Ÿè®¡
        expenseByCategory: [],
        incomeByCategory: [],

        // å†å²å¯¹æ¯”æ•°æ®
        historicalData: {
            lastPeriod: {
                totalIncome: 0,
                totalExpense: 0,
                savingsRate: 0,
                expenseIncomeRatio: 0
            },
            categoryHistory: []
        },

        // å•†æˆ·åˆ†æ
        merchantAnalysis: {
            topByAmount: [],
            topByFrequency: []
        },

        // è´¦å•æ˜ç»†ï¼ˆæœåŠ¡ç«¯å·²è®¡ç®—å®Œæˆï¼Œå‰ç«¯ä¸å†ä¾èµ–ï¼‰
        bills: [],

        // ç»Ÿè®¡æ¦‚è§ˆï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        overview: {
            totalTransactions: 0,
            netIncome: 0,
            savingsRate: 0,
            incomeChange: "0%",
            expenseChange: "0%",
            dailyTransactions: 0
        },

        // æ—¥å‡ç»Ÿè®¡ï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        dailyStats: {
            totalExpenseCount: 0,
            totalIncomeCount: 0,
            dailyExpenseFreq: 0,
            dailyIncomeFreq: 0
        },

        // æ”¶æ”¯è¶‹åŠ¿ï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        trend: {
            labels: [],
            incomes: [],
            expenses: []
        },

        // 24å°æ—¶æ¶ˆè´¹åˆ†å¸ƒï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        hourStats: {
            hours: [],
            amounts: [],
            counts: []
        },

        // æ—¶é—´æ´å¯Ÿï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        timeInsight: {
            peakHour: "00:00",
            peakAmount: 0,
            peakCount: 0,
            nightRatio: 0,
            patternText: "",
            patternTag: "tag-success"
        },

        // ç”Ÿç‰©é’Ÿçƒ­åŠ›å›¾ï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        heatmap: {
            weekDays: [],
            hours: [],
            values: [],
            maxValue: 0
        },

        // é‡‘é¢åˆ†å¸ƒï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        amountDistribution: {
            labels: [],
            counts: []
        },

        // æ¶ˆè´¹è±¡é™ï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        scatter: {
            medianFreq: 0,
            medianAvg: 0,
            points: []
        },

        // æ¶ˆè´¹çƒ­è¯äº‘ï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        wordCloud: {
            words: []
        },

        // åˆ†ç±»æ´å¯Ÿï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        categoryInsight: {
            expense: {
                category: "",
                amount: 0,
                percentage: 0,
                count: 0,
                avgPerTransaction: 0
            },
            income: {
                category: "",
                amount: 0,
                percentage: 0,
                count: 0,
                avgPerTransaction: 0
            }
        },

        // æ¶ˆè´¹æ´å¯Ÿï¼ˆæœåŠ¡ç«¯é¢„è®¡ç®—ï¼‰
        insights: {
            profile: {
                text: "",
                category: "",
                avgExpense: 0
            },
            tags: [],
            latteFactor: {
                amount: 0,
                count: 0,
                coffee: 0
            },
            largeExpense: {
                amount: 0,
                count: 0,
                ratio: 0
            },
            weekend: {
                amount: 0,
                ratio: 0
            }
        }
    };

    // å½“å‰æ•°æ®
    let currentData = defaultData;
    
    // ä¸»é¢˜é¢œè‰²é…ç½®
    let themeColors = {
        income: '#10b981', // é»˜è®¤ç»¿è‰²
        expense: '#ef4444' // é»˜è®¤çº¢è‰²
    };

    // å›¾è¡¨å®ä¾‹å­˜å‚¨
    let charts = {};
    
    // å½“å‰é€‰ä¸­çš„åˆ†ç±»ç±»å‹
    let currentCategoryType = 'expense';

    /**
     * æ ¼å¼åŒ–é‡‘é¢
     */
    function formatMoney(amount) {
        return 'Â¥' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    /**
     * æ¸²æŸ“æ€»è§ˆç»Ÿè®¡
     */
    function renderOverview(data) {
        const { basicStats, overview } = data;
        const summary = overview || {};

        const totalTransactions = summary.totalTransactions || 0;
        const netIncome = summary.netIncome ?? (basicStats.totalIncome - basicStats.totalExpense);
        const savingsRate = summary.savingsRate ?? 0;

        const incomeChange = summary.incomeChange || "0%";
        const expenseChange = summary.expenseChange || "0%";

        const statsHtml = `
            <div class="stat-item">
                <div class="stat-label">æ€»æ”¶å…¥</div>
                <div class="stat-value income">${formatMoney(basicStats.totalIncome)}</div>
                <div class="stat-compare">
                    åŒæœŸå¯¹æ¯” ${incomeChange}
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ€»æ”¯å‡º</div>
                <div class="stat-value expense">${formatMoney(basicStats.totalExpense)}</div>
                <div class="stat-compare">
                    åŒæœŸå¯¹æ¯” ${expenseChange}
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ç»“ä½™</div>
                <div class="stat-value primary">${formatMoney(netIncome)}</div>
                <div class="stat-compare">
                    å‚¨è“„ç‡ ${savingsRate.toFixed ? savingsRate.toFixed(1) : savingsRate}%
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">äº¤æ˜“æ€»æ•°</div>
                <div class="stat-value primary">${totalTransactions}</div>
                <div class="stat-compare">
                    æ—¥å‡ ${summary.dailyTransactions ? summary.dailyTransactions.toFixed(1) : "0.0"} ç¬”
                </div>
            </div>
        `;
        document.getElementById('overviewStats').innerHTML = statsHtml;
    }

    /**
     * æ¸²æŸ“æ—¥å‡ç»Ÿè®¡
     */
    function renderDailyStats(data) {
        const { basicStats, dailyStats } = data;
        const stats = dailyStats || {};

        const statsHtml = `
            <div class="stat-item">
                <div class="stat-label">æ—¥å‡æ”¯å‡º</div>
                <div class="stat-value expense">${formatMoney(basicStats.avgExpensePerDay || 0)}</div>
                <div class="stat-compare">
                    æœˆå‡ ${formatMoney((basicStats.avgExpensePerDay || 0) * 30)}
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ—¥å‡æ”¶å…¥</div>
                <div class="stat-value income">${formatMoney(basicStats.avgIncomePerDay || 0)}</div>
                <div class="stat-compare">
                    æœˆå‡ ${formatMoney((basicStats.avgIncomePerDay || 0) * 30)}
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ—¥å‡æ”¯å‡ºé¢‘ç‡</div>
                <div class="stat-value primary">${(stats.dailyExpenseFreq || 0).toFixed(2)}</div>
                <div class="stat-compare">
                    æ¬¡/å¤©ï¼Œå…± ${stats.totalExpenseCount || 0} æ¬¡
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ—¥å‡æ”¶å…¥é¢‘ç‡</div>
                <div class="stat-value primary">${(stats.dailyIncomeFreq || 0).toFixed(2)}</div>
                <div class="stat-compare">
                    æ¬¡/å¤©ï¼Œå…± ${stats.totalIncomeCount || 0} æ¬¡
                </div>
            </div>
        `;
        document.getElementById('dailyStats').innerHTML = statsHtml;
    }

    /**
     * æ¸²æŸ“è¶‹åŠ¿å›¾
     */
    function renderTrendChart(data) {
        const trend = data.trend || {};
        const labels = trend.labels || [];
        const incomes = trend.incomes || [];
        const expenses = trend.expenses || [];
        
        if (labels.length === 0) {
            document.getElementById('trendChart').innerHTML = '<div class="empty-state"><div class="icon">ğŸ“Š</div><div class="text">æš‚æ— æ•°æ®</div></div>';
            return;
        }

        const theme = window.__isDarkMode ? 'dark' : 'light';
        const chart = echarts.init(document.getElementById('trendChart'), theme);
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                textStyle: { color: '#1e293b' }
            },
            legend: {
                data: ['æ”¶å…¥', 'æ”¯å‡º'],
                textStyle: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-text') }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: labels,
                boundaryGap: false,
                axisLine: { lineStyle: { color: '#e2e8f0' } },
                axisLabel: { color: '#64748b' }
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    formatter: (value) => 'Â¥' + value,
                    color: '#64748b'
                },
                axisLine: { lineStyle: { color: '#e2e8f0' } },
                splitLine: { lineStyle: { color: '#f1f5f9' } }
            },
            series: [
                {
                    name: 'æ”¶å…¥',
                    type: 'line',
                    data: incomes,
                    smooth: true,
                    itemStyle: { color: themeColors.income },
                    lineStyle: { width: 3 },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: hexToRgba(themeColors.income, 0.3) },
                            { offset: 1, color: hexToRgba(themeColors.income, 0.05) }
                        ])
                    }
                },
                {
                    name: 'æ”¯å‡º',
                    type: 'line',
                    data: expenses,
                    smooth: true,
                    itemStyle: { color: themeColors.expense },
                    lineStyle: { width: 3 },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: hexToRgba(themeColors.expense, 0.3) },
                            { offset: 1, color: hexToRgba(themeColors.expense, 0.05) }
                        ])
                    }
                }
            ]
        };
        chart.setOption(option);
        charts.trendChart = chart;
    }

    /**
     * æ¸²æŸ“åˆ†ç±»å›¾è¡¨
     */
    function renderCategoryChart(categories, type, summaryData) {
        const chartEl = document.getElementById('categoryChart');
        const insightEl = document.getElementById('categoryInsight');
        
        // 1. é”€æ¯æ—§å®ä¾‹ï¼šæ— è®ºæ˜¯å¦æœ‰æ–°æ•°æ®ï¼Œå…ˆæ¸…ç†æ—§çš„
        if (charts.categoryChart) {
            charts.categoryChart.dispose();
            charts.categoryChart = null;
        }
        
        // 2. æ¸…ç†å®¹å™¨ï¼šé˜²æ­¢ ECharts åœ¨éç©ºå®¹å™¨ä¸Šåˆå§‹åŒ–æŠ¥é”™ï¼Œæˆ–æ®‹ç•™ç©ºçŠ¶æ€ HTML
        chartEl.innerHTML = '';
        insightEl.innerHTML = ''; // åŒæ—¶æ¸…ç†æ´å¯ŸåŒºåŸŸ

        if (!categories || categories.length === 0) {
            chartEl.innerHTML = '<div class="empty-state"><div class="icon">ğŸ·ï¸</div><div class="text">æš‚æ— åˆ†ç±»æ•°æ®</div></div>';
            return;
        }

        const theme = window.__isDarkMode ? 'dark' : 'light';
        const chart = echarts.init(chartEl, theme);
        const seriesData = categories.map(cat => ({
            name: cat.category,
            value: cat.amount
        }));

        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{b}<br/>é‡‘é¢: Â¥{c}<br/>å æ¯”: {d}%',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                textStyle: { color: '#1e293b' }
            },
            legend: {
                // å›¾ä¾‹ç§»åˆ°åº•éƒ¨ï¼Œå‡å°‘æ¨ªå‘å ç”¨
                orient: 'horizontal',
                left: 'center',
                bottom: 0,
                type: 'scroll',
                textStyle: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-text') }
            },
            series: [{
                type: 'pie',
                radius: ['45%', '65%'],
                center: ['50%', '45%'],
                avoidLabelOverlap: true,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#fff',
                    borderWidth: 2
                },
                label: {
                    show: true,
                    formatter: '{b}\n{d}%',
                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                },
                emphasis: {
                    label: { show: true, fontSize: 16, fontWeight: 'bold' },
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                },
                data: seriesData
            }]
        };
        chart.setOption(option);
        charts.categoryChart = chart;

        // æ¸²æŸ“åˆ†ç±»æ´å¯Ÿ
        renderCategoryInsight(summaryData, type);
    }

    /**
     * æ¸²æŸ“åˆ†ç±»æ´å¯Ÿ
     */
    function renderCategoryInsight(data, type) {
        const insights = data.categoryInsight || {};
        const insight = type === 'expense' ? insights.expense : insights.income;
        if (!insight || !insight.category) return;

        const insightHtml = `
            <div class="insight-card">
                <div class="insight-title">ğŸ’¡ ${type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}æ´å¯Ÿ</div>
                <div class="insight-content">
                    ${type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}æœ€å¤šçš„ç±»åˆ«æ˜¯<strong>${insight.category}</strong>ï¼Œ
                    é‡‘é¢ä¸º <strong>${formatMoney(insight.amount)}</strong>ï¼Œ
                    å æ€»${type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}çš„ <strong>${(insight.percentage || 0).toFixed(1)}%</strong>ã€‚
                    ${type === 'expense'
                        ? `å¹³å‡å•æ¬¡æ¶ˆè´¹ <strong>${formatMoney(insight.avgPerTransaction)}</strong>ï¼Œæ¶ˆè´¹ <strong>${insight.count}</strong> æ¬¡ã€‚`
                        : `å¹³å‡å•æ¬¡æ”¶å…¥ <strong>${formatMoney(insight.avgPerTransaction)}</strong>ï¼Œå…± <strong>${insight.count}</strong> æ¬¡ã€‚`
                    }
                </div>
            </div>
        `;
        document.getElementById('categoryInsight').innerHTML = insightHtml;
    }

    /**
     * åˆ‡æ¢åˆ†ç±»tab
     */
    function switchCategoryTab(type) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        currentCategoryType = type;
        const categories = type === 'expense' ? currentData.expenseByCategory : currentData.incomeByCategory;
        renderCategoryChart(categories, type, currentData);
    }

    /**
     * æ¸²æŸ“æ¶ˆè´¹æ—¶é—´è§„å¾‹
     */
    function renderHourChart(data) {
        const stats = data.hourStats || {};
        const hours = stats.hours || [];
        const amounts = stats.amounts || [];
        const counts = stats.counts || [];

        if (hours.length === 0) {
            document.getElementById('hourChart').innerHTML = '<div class="empty-state"><div class="icon">ğŸ•</div><div class="text">æš‚æ— æ•°æ®</div></div>';
            return;
        }

        const theme = window.__isDarkMode ? 'dark' : 'light';
        const chart = echarts.init(document.getElementById('hourChart'), theme);
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                textStyle: { color: '#1e293b' }
            },
            legend: {
                data: ['æ¶ˆè´¹é‡‘é¢', 'æ¶ˆè´¹æ¬¡æ•°'],
                textStyle: { color: getComputedStyle(document.documentElement).getPropertyValue('--color-text') }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: hours,
                axisLine: { lineStyle: { color: '#e2e8f0' } },
                axisLabel: { 
                    color: '#64748b',
                    interval: 1
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: 'é‡‘é¢(Â¥)',
                    axisLabel: {
                        formatter: (value) => 'Â¥' + value,
                        color: '#64748b'
                    },
                    axisLine: { lineStyle: { color: '#e2e8f0' } },
                    splitLine: { lineStyle: { color: '#f1f5f9' } }
                },
                {
                    type: 'value',
                    name: 'æ¬¡æ•°',
                    axisLabel: {
                        formatter: (value) => value + 'æ¬¡',
                        color: '#64748b'
                    },
                    axisLine: { lineStyle: { color: '#e2e8f0' } },
                    splitLine: { show: false }
                }
            ],
            series: [
                {
                    name: 'æ¶ˆè´¹é‡‘é¢',
                    type: 'bar',
                    data: amounts,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#60a5fa' },
                            { offset: 1, color: '#3b82f6' }
                        ])
                    }
                },
                {
                    name: 'æ¶ˆè´¹æ¬¡æ•°',
                    type: 'line',
                    yAxisIndex: 1,
                    data: counts,
                    smooth: true,
                    itemStyle: { color: '#f59e0b' },
                    lineStyle: { width: 3 }
                }
            ]
        };
        chart.setOption(option);
        charts.hourChart = chart;

        // æ¸²æŸ“æ—¶é—´æ´å¯Ÿ
        renderTimeInsight(data.timeInsight || {});
    }

    /**
     * æ¸²æŸ“æ—¶é—´æ´å¯Ÿ
     */
    function renderTimeInsight(insight) {
        if (!insight || !insight.peakHour) {
            document.getElementById('timeInsight').innerHTML = '';
            return;
        }

        const insightHtml = `
            <div class="insight-card">
                <div class="insight-title">ğŸ’¡ æ—¶é—´è§„å¾‹æ´å¯Ÿ</div>
                <div class="insight-content">
                    æ‚¨çš„æ¶ˆè´¹é«˜å³°æ—¶æ®µæ˜¯ <strong>${insight.peakHour}</strong>ï¼Œ
                    è¯¥æ—¶æ®µæ¶ˆè´¹é‡‘é¢ä¸º <strong>${formatMoney(insight.peakAmount || 0)}</strong>ï¼Œ
                    æ¶ˆè´¹ <strong>${insight.peakCount || 0}</strong> æ¬¡ã€‚
                    æ·±å¤œæ¶ˆè´¹å æ¯” <strong>${(insight.nightRatio || 0).toFixed(1)}%</strong>ã€‚
                    <div style="margin-top: 8px;">
                        <span class="tag ${insight.patternTag || 'tag-success'}">æ¶ˆè´¹æ¨¡å¼: ${insight.patternText || 'æš‚æ— æ•°æ®'}</span>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('timeInsight').innerHTML = insightHtml;
    }

    /**
     * æ¸²æŸ“é‡‘é¢åˆ†å¸ƒ
     */
    function renderAmountDistChart(data) {
        const dist = data.amountDistribution || {};
        const labels = dist.labels || [];
        const counts = dist.counts || [];

        if (labels.length === 0) {
            document.getElementById('amountDistChart').innerHTML = '<div class="empty-state"><div class="icon">ğŸ’°</div><div class="text">æš‚æ— æ•°æ®</div></div>';
            return;
        }

        const theme = window.__isDarkMode ? 'dark' : 'light';
        const chart = echarts.init(document.getElementById('amountDistChart'), theme);
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                textStyle: { color: '#1e293b' }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: labels,
                axisLine: { lineStyle: { color: '#e2e8f0' } },
                axisLabel: { color: '#64748b' }
            },
            yAxis: {
                type: 'value',
                name: 'æ¶ˆè´¹æ¬¡æ•°',
                axisLabel: { color: '#64748b' },
                axisLine: { lineStyle: { color: '#e2e8f0' } },
                splitLine: { lineStyle: { color: '#f1f5f9' } }
            },
            series: [{
                name: 'æ¬¡æ•°',
                type: 'bar',
                data: counts,
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: '#a78bfa' },
                        { offset: 1, color: '#8b5cf6' }
                    ]),
                    borderRadius: [8, 8, 0, 0]
                },
                emphasis: {
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#c4b5fd' },
                            { offset: 1, color: '#a78bfa' }
                        ])
                    }
                }
            }]
        };
        chart.setOption(option);
        charts.amountDistChart = chart;
    }

    /**
     * æ¸²æŸ“æ¶ˆè´¹æ´å¯Ÿ
     */
    function renderInsights(data) {
        const insight = data.insights || {};
        const profile = insight.profile || {};
        const tags = insight.tags || [];

        const insightsHtml = `
            <div style="display: grid; gap: 16px;">
                <!-- æ¶ˆè´¹ç”»åƒä¸»å¡ç‰‡ -->
                <div class="insight-card">
                    <div class="insight-title">ğŸ¯ æ¶ˆè´¹ç”»åƒ</div>
                    <div class="insight-content">
                        <div style="margin-bottom: 12px;">
                            ${tags.map(tag => `<span class="tag ${tag.class}">${tag.text}</span>`).join('')}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: var(--color-text-muted);">æ¶ˆè´¹æ—¶é—´</div>
                                <div style="font-weight: 600; color: var(--color-text);">${data.timeInsight?.patternText || 'è§„å¾‹'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--color-text-muted);">æ¶ˆè´¹åå¥½</div>
                                <div style="font-weight: 600; color: var(--color-text);">${profile.category || 'æš‚æ— '} (${(data.categoryInsight?.expense?.percentage || 0).toFixed(1)}%)</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--color-text-muted);">æ¶ˆè´¹è§„å¾‹</div>
                                <div style="font-weight: 600; color: var(--color-text);">${profile.text || 'æš‚æ— æ•°æ®'}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--color-text-muted);">æ¶ˆè´¹èƒ½åŠ›</div>
                                <div style="font-weight: 600; color: var(--color-text);">æ—¥å‡ ${formatMoney(data.basicStats?.avgExpensePerDay || 0)}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="insight-card" style="background: var(--color-warning-bg); border-left-color: var(--color-warning);">
                    <div class="insight-title" style="color: var(--color-warning);">â˜• æ‹¿é“å› å­</div>
                    <div class="insight-content">
                        æ‚¨åœ¨å°é¢æ¶ˆè´¹ï¼ˆ<100å…ƒï¼‰ä¸ŠèŠ±è´¹äº† <strong>${formatMoney(insight.latteFactor?.amount || 0)}</strong>ï¼Œ
                        å…± <strong>${insight.latteFactor?.count || 0}</strong> æ¬¡ï¼Œç›¸å½“äº <strong>${(insight.latteFactor?.coffee || 0).toFixed(0)}</strong> æ¯å’–å•¡ã€‚
                        ${insight.latteFactor?.suggestion || ''}
                    </div>
                </div>

                <div class="insight-card" style="background: var(--color-danger-bg); border-left-color: var(--color-danger);">
                    <div class="insight-title" style="color: var(--color-danger);">ğŸ’ å¤§é¢æ”¯å‡º</div>
                    <div class="insight-content">
                        å¤§é¢æ¶ˆè´¹ï¼ˆ>1000å…ƒï¼‰å…± <strong>${insight.largeExpense?.count || 0}</strong> ç¬”ï¼Œ
                        é‡‘é¢ <strong>${formatMoney(insight.largeExpense?.amount || 0)}</strong>ï¼Œ
                        å æ€»æ”¯å‡ºçš„ <strong>${(insight.largeExpense?.ratio || 0).toFixed(1)}%</strong>ã€‚
                        ${insight.largeExpense?.suggestion || ''}
                    </div>
                </div>

                <div class="insight-card">
                    <div class="insight-title">ğŸ“… å‘¨æœ«æ•ˆåº”</div>
                    <div class="insight-content">
                        å‘¨æœ«æ¶ˆè´¹å æ€»æ”¯å‡ºçš„ <strong>${(insight.weekend?.ratio || 0).toFixed(1)}%</strong>ï¼Œ
                        é‡‘é¢ä¸º <strong>${formatMoney(insight.weekend?.amount || 0)}</strong>ã€‚
                        ${insight.weekend?.suggestion || ''}
                    </div>
                </div>
            </div>
        `;
        document.getElementById('insightContent').innerHTML = insightsHtml;
    }

    /**
     * æ¸²æŸ“æ¶ˆè´¹ç”Ÿç‰©é’Ÿçƒ­åŠ›å›¾
     */
    function renderHeatmapChart(data) {
        const heatmap = data.heatmap || {};
        const weekDays = heatmap.weekDays || [];
        const hours = heatmap.hours || [];
        const values = heatmap.values || [];
        const maxValue = heatmap.maxValue || 0;

        if (values.length === 0) {
            document.getElementById('heatmapChart').innerHTML = '<div class="empty-state"><div class="icon">ğŸ”¥</div><div class="text">æš‚æ— æ•°æ®</div></div>';
            return;
        }

        const theme = window.__isDarkMode ? 'dark' : 'light';
        const chart = echarts.init(document.getElementById('heatmapChart'), theme);
        const option = {
            tooltip: {
                position: 'top',
                formatter: function(params) {
                    return weekDays[params.value[1]] + ' ' + params.value[0] + ':00<br/>æ¶ˆè´¹: ' + formatMoney(parseFloat(params.value[2]));
                },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                textStyle: { color: '#1e293b' }
            },
            grid: {
                left: '10%',
                right: '10%',
                top: '5%',
                bottom: '10%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: hours,
                splitArea: { show: true },
                axisLabel: {
                    color: '#64748b',
                    interval: 2
                },
                axisLine: { show: false }
            },
            yAxis: {
                type: 'category',
                data: weekDays,
                splitArea: { show: true },
                axisLabel: { color: '#64748b' },
                axisLine: { show: false }
            },
            visualMap: {
                min: 0,
                max: maxValue,
                calculable: true,
                orient: 'horizontal',
                left: 'center',
                bottom: '0%',
                inRange: {
                    color: ['#e0f2fe', '#7dd3fc', '#38bdf8', '#0284c7', '#0369a1']
                },
                textStyle: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text')
                }
            },
            series: [{
                name: 'æ¶ˆè´¹é‡‘é¢',
                type: 'heatmap',
                data: values,
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };
        chart.setOption(option);
        charts.heatmapChart = chart;
    }

    /**
     * æ¸²æŸ“æ¶ˆè´¹è±¡é™ï¼ˆé¢‘æ¬¡ vs å‡ä»·ï¼‰
     */
    function renderScatterChart(data) {
        const scatter = data.scatter || {};
        const points = scatter.points || [];

        if (points.length === 0) {
            document.getElementById('scatterChart').innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><div class="text">æš‚æ— æ•°æ®</div></div>';
            return;
        }
        const scatterData = points.map(point => ({
            value: [point.freq, point.avgPrice],
            name: point.name,
            amount: point.amount,
            color: point.color,
            size: point.size
        }));

        const theme = window.__isDarkMode ? 'dark' : 'light';
        const chart = echarts.init(document.getElementById('scatterChart'), theme);
        const option = {
            tooltip: {
                formatter: function(params) {
                    return params.data.name + '<br/>' +
                           'æ¶ˆè´¹æ¬¡æ•°: ' + params.data.value[0] + ' æ¬¡<br/>' +
                           'å¹³å‡å•ä»·: ' + formatMoney(params.data.value[1]) + '<br/>' +
                           'æ€»é‡‘é¢: ' + formatMoney(params.data.amount);
                },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                textStyle: { color: '#1e293b' }
            },
            grid: {
                left: '10%',
                right: '10%',
                bottom: '10%',
                top: '5%',
                containLabel: true
            },
            xAxis: {
                name: 'æ¶ˆè´¹é¢‘æ¬¡ï¼ˆæ¬¡ï¼‰',
                nameLocation: 'middle',
                nameGap: 30,
                nameTextStyle: { color: '#64748b' },
                type: 'value',
                axisLabel: { color: '#64748b' },
                axisLine: { lineStyle: { color: '#e2e8f0' } },
                splitLine: { lineStyle: { color: '#f1f5f9' } }
            },
            yAxis: {
                name: 'å¹³å‡å•ä»·ï¼ˆÂ¥ï¼‰',
                nameLocation: 'middle',
                nameGap: 50,
                nameTextStyle: { color: '#64748b' },
                type: 'value',
                axisLabel: {
                    formatter: (value) => 'Â¥' + value.toFixed(0),
                    color: '#64748b'
                },
                axisLine: { lineStyle: { color: '#e2e8f0' } },
                splitLine: { lineStyle: { color: '#f1f5f9' } }
            },
            series: [{
                type: 'scatter',
                data: scatterData,
                symbolSize: function(data, params) {
                    const item = scatterData[params.dataIndex];
                    return item && item.size ? item.size : 10;
                },
                itemStyle: {
                    color: function(params) {
                        return params.data.color || '#10b981';
                    },
                    opacity: 0.7
                },
                label: {
                    show: true,
                    formatter: '{@[2]}',
                    position: 'top',
                    color: getComputedStyle(document.documentElement).getPropertyValue('--color-text'),
                    fontSize: 11
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)',
                        opacity: 1
                    }
                }
            }]
        };
        chart.setOption(option);
        charts.scatterChart = chart;
    }

    /**
     * æ¸²æŸ“æ¶ˆè´¹çƒ­è¯äº‘
     */
    function renderWordCloudChart(data) {
        const words = data.wordCloud?.words || [];

        if (words.length === 0) {
            document.getElementById('wordCloudChart').innerHTML = '<div class="empty-state"><div class="icon">â˜ï¸</div><div class="text">æš‚æ— æ•°æ®</div></div>';
            return;
        }

        const theme = window.__isDarkMode ? 'dark' : 'light';
        const chart = echarts.init(document.getElementById('wordCloudChart'), theme);
        const option = {
            tooltip: {
                formatter: function(params) {
                    return params.name + '<br/>æ¶ˆè´¹: ' + formatMoney(params.value);
                },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#e2e8f0',
                textStyle: { color: '#1e293b' }
            },
            series: [{
                type: 'wordCloud',
                gridSize: 8,
                sizeRange: [14, 60],
                rotationRange: [-45, 45],
                rotationStep: 45,
                shape: 'circle',
                width: '100%',
                height: '100%',
                textStyle: {
                    fontFamily: 'sans-serif',
                    fontWeight: 'bold',
                    color: function(params) {
                        return params.data.color || '#3b82f6';
                    }
                },
                emphasis: {
                    focus: 'self',
                    textStyle: {
                        shadowBlur: 10,
                        shadowColor: '#333'
                    }
                },
                data: words
            }]
        };
        chart.setOption(option);
        charts.wordCloudChart = chart;
    }

    /**
     * ä¸»æ¸²æŸ“å‡½æ•°
     */
    function renderAll(data) {
        currentData = data;

        renderOverview(data);
        renderDailyStats(data);
        renderTrendChart(data);
        renderCategoryChart(data.expenseByCategory, 'expense', data);
        renderHourChart(data);
        renderHeatmapChart(data);
        renderAmountDistChart(data);
        renderScatterChart(data);
        renderInsights(data);
        renderWordCloudChart(data);
        // è¯äº‘å·²è¦†ç›–å•†æˆ·ä¿¡æ¯ï¼Œç§»é™¤æœ€å¸¸å…‰é¡¾åˆ—è¡¨
    }

    /**
     * æ·±åº¦åˆå¹¶å¯¹è±¡
     */
    function deepMerge(target, source) {
        const result = { ...target };
        for (const key in source) {
            if (source.hasOwnProperty(key)) {
                if (source[key] instanceof Object && !Array.isArray(source[key]) && target[key] instanceof Object && !Array.isArray(target[key])) {
                    result[key] = deepMerge(target[key], source[key]);
                } else {
                    result[key] = source[key];
                }
            }
        }
        return result;
    }

    /**
     * å¤–éƒ¨è°ƒç”¨æ¥å£ï¼šè®¾ç½®ä¸»é¢˜é¢œè‰²
     * @param {string} incomeColor - æ”¶å…¥é¢œè‰² (hex)
     * @param {string} expenseColor - æ”¯å‡ºé¢œè‰² (hex)
     */
    function setThemeColors(incomeColor, expenseColor) {
        themeColors.income = incomeColor;
        themeColors.expense = expenseColor;
        
        // æ›´æ–°CSSå˜é‡
        document.documentElement.style.setProperty('--color-income', incomeColor);
        document.documentElement.style.setProperty('--color-expense', expenseColor);
        
        // å¦‚æœå·²æœ‰æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥åº”ç”¨æ–°é¢œè‰²
        if (charts.trendChart) {
            renderTrendChart(currentData);
        }
        // å…¶ä»–å›¾è¡¨å¦‚æœä½¿ç”¨äº†ç‰¹å®šé¢œè‰²ä¹Ÿéœ€è¦åˆ·æ–°ï¼Œä½†ç›®å‰ä¸»è¦æ˜¯è¶‹åŠ¿å›¾ä½¿ç”¨äº†ç¡¬ç¼–ç é¢œè‰²
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šHexè½¬RGBA
     */
    function hexToRgba(hex, alpha) {
        let r = parseInt(hex.slice(1, 3), 16);
        let g = parseInt(hex.slice(3, 5), 16);
        let b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    /**
     * å¤–éƒ¨è°ƒç”¨æ¥å£ï¼šè®¾ç½®æ•°æ®å¹¶æ¸²æŸ“
     * @param {Object} jsonData - å¤–éƒ¨ä¼ å…¥çš„æ•°æ®ï¼Œæ ¼å¼ä¸SummaryService.generateSummary()è¿”å›çš„JSONä¸€è‡´
     * 
     * æ•°æ®æ ¼å¼ç¤ºä¾‹ï¼š
     * {
     *   period: "2024å¹´1æœˆ",
     *   periodDays: 31,
     *   basicStats: {
     *     totalIncome: 10000,
     *     totalExpense: 5000,
     *     hasIncome: true,
     *     avgIncomePerDay: 322.58,
     *     avgExpensePerDay: 161.29
     *   },
     *   expenseByCategory: [
     *     { category: "é¤é¥®", amount: 2000, percentage: 40, count: 50, avgPerDay: 64.52 }
     *   ],
     *   incomeByCategory: [...],
     *   historicalData: {
     *     lastPeriod: { totalIncome: 9000, totalExpense: 4500 }
     *   },
     *   merchantAnalysis: {
     *     topByAmount: [{ merchant: "å•†æˆ·å", amount: 1000, count: 10 }]
     *   },
     *   bills: [
     *     { type: "Expend", amount: 100, category: "é¤é¥®", merchant: "å•†æˆ·", time: 1234567890, date: "2024-01-01", hour: 12 }
     *   ]
     * }
     */
    function setJson(jsonData) {
        // æ·±åº¦åˆå¹¶å¤–éƒ¨æ•°æ®å’Œé»˜è®¤æ•°æ®
        const data = deepMerge(defaultData, jsonData || {});
        
        // æ›´æ–°å½“å‰æ•°æ®
        currentData = data;
        
        // æ¸²æŸ“é¡µé¢
        renderAll(data);
    }

    /**
     * å“åº”å¼å¤„ç†
     */
    window.addEventListener('resize', () => {
        Object.values(charts).forEach(chart => {
            if (chart && chart.resize) chart.resize();
        });
    });

    /**
     * é¡µé¢åŠ è½½
     */
    document.addEventListener('DOMContentLoaded', () => {
        renderAll(defaultData);
    });

    /**
     * éšç§æ¨¡å¼æ§åˆ¶ï¼šéšè—/æ˜¾ç¤ºé‡‘é¢
     * @param {boolean} enabled - true=éšè—é‡‘é¢ï¼Œfalse=æ˜¾ç¤ºé‡‘é¢
     */
    function togglePrivacyMode(enabled) {
        // é€’å½’éå†æŒ‡å®šå…ƒç´ çš„æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
        function processTextNodes(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                if (enabled) {
                    // å¼€å¯éšç§æ¨¡å¼ï¼šåŒ¹é…é‡‘é¢æ ¼å¼
                    // æ”¯æŒæ ¼å¼ï¼šÂ¥100, Â¥ 100, Â¥-100, Â¥ -100
                    if (/Â¥\s*-?[\d,.]+/.test(node.nodeValue)) {
                        if (!node._originalText) {
                            node._originalText = node.nodeValue;
                        }
                        node.nodeValue = node.nodeValue.replace(/Â¥\s*-?[\d,.]+/g, 'Â¥***');
                    }
                } else {
                    // å…³é—­éšç§æ¨¡å¼ï¼šå¦‚æœæœ‰å¤‡ä»½åˆ™æ¢å¤
                    if (node._originalText) {
                        node.nodeValue = node._originalText;
                        delete node._originalText;
                    }
                }
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                // é€’å½’å¤„ç†å­èŠ‚ç‚¹
                node.childNodes.forEach(processTextNodes);
            }
        }

        // é€‰æ‹©æ‰€æœ‰å¯èƒ½åŒ…å«é‡‘é¢çš„å®¹å™¨
        const selectors = [
            '.stat-value',         // ç»Ÿè®¡æ•°å€¼
            '.stat-compare',       // ç»Ÿè®¡å¯¹æ¯”
            '.insight-content',    // æ´å¯Ÿå†…å®¹
            '.insight-card',       // æ´å¯Ÿå¡ç‰‡
            '.stat-item'           // ç»Ÿè®¡é¡¹ï¼ˆæ€»è§ˆåŒºåŸŸï¼‰
        ];

        // éå†æ‰€æœ‰åŒ¹é…çš„å…ƒç´ 
        document.querySelectorAll(selectors.join(', ')).forEach(el => {
            processTextNodes(el);
        });
    }

    // æš´éœ²æ¥å£åˆ°å…¨å±€
    window.setJson = setJson;
    window.setThemeColors = setThemeColors;
    window.switchCategoryTab = switchCategoryTab;
    window.togglePrivacyMode = togglePrivacyMode;

    /* ========================================
     * ä½¿ç”¨è¯´æ˜
     * ========================================
     * 
     * 1. å¤–éƒ¨è°ƒç”¨æ–¹å¼ï¼š
     *    window.setJson(data);
     * 
     * 2. æ•°æ®æ ¼å¼ï¼š
     *    æ•°æ®æ ¼å¼ä¸ SummaryService.generateSummary() è¿”å›çš„ JSON å®Œå…¨ä¸€è‡´
     * 
     * 3. æ•°æ®å­—æ®µè¯´æ˜ï¼š
     *    - period: å‘¨æœŸåç§°ï¼ˆå¦‚"2024å¹´1æœˆ"ï¼‰
     *    - periodDays: å‘¨æœŸå¤©æ•°
     *    - basicStats: åŸºç¡€ç»Ÿè®¡ï¼ˆæ”¶å…¥ã€æ”¯å‡ºã€æ—¥å‡ç­‰ï¼‰
     *    - expenseByCategory: æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡æ•°ç»„
     *    - incomeByCategory: æ”¶å…¥åˆ†ç±»ç»Ÿè®¡æ•°ç»„
     *    - historicalData: å†å²å¯¹æ¯”æ•°æ®
     *    - merchantAnalysis: å•†æˆ·åˆ†ææ•°æ®
     *    - bills: è´¦å•æ˜ç»†æ•°ç»„ï¼ˆç”¨äºç”Ÿæˆè¶‹åŠ¿å›¾ã€çƒ­åŠ›å›¾ç­‰ï¼‰
     * 
     * 4. éƒ¨åˆ†æ›´æ–°ï¼š
     *    æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°ï¼Œæœªæä¾›çš„å­—æ®µä¼šä½¿ç”¨é»˜è®¤å€¼
     *    ä¾‹å¦‚ï¼šwindow.setJson({ period: "2024å¹´2æœˆ" })
     * 
     * 5. ç¤ºä¾‹ï¼š
     *    window.setJson({
     *        period: "2024å¹´1æœˆ",
     *        periodDays: 31,
     *        basicStats: {
     *            totalIncome: 10000,
     *            totalExpense: 5000
     *        },
     *        bills: [...]
     *    });
     * 
     * ======================================== */
</script>
</body>
</html>
